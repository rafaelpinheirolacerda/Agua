<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Desafio da 츼gua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#e0f2fe" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: #e0f2fe; /* azul claro de fundo */
      color: #111827;
    }

    h1 {
      text-align: center;
      margin-bottom: 8px;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 16px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .goal-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .goal-group input {
      width: 80px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }

    .reset-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      background: #fee2e2;
      color: #b91c1c;
    }

    .reset-btn:hover {
      filter: brightness(0.96);
    }

    .players {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    @media (max-width: 700px) {
      .players {
        grid-template-columns: 1fr;
      }
    }

    .card {
      border-radius: 12px;
      padding: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .name-input {
      border: none;
      background: transparent;
      border-bottom: 1px dashed #d1d5db;
      padding: 2px 4px;
      font-size: 1rem;
      min-width: 0;
    }

    .name-input:focus {
      outline: none;
      border-color: #60a5fa;
    }

    .total {
      font-size: 0.9rem;
      color: #4b5563;
      text-align: right;
    }

    .total strong {
      font-size: 1.1rem;
      color: #111827;
    }

    .progress-bar-wrapper {
      width: 100%;
      height: 14px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin: 6px 0 4px 0;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #38bdf8, #3b82f6);
      transition: width 0.2s ease-out;
    }

    .progress-text {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: right;
      margin-bottom: 8px;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .btn {
      flex: 1 1 80px;
      text-align: center;
      padding: 6px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      background: #dbeafe;
      color: #1d4ed8;
      white-space: nowrap;
    }

    .btn:hover {
      filter: brightness(0.96);
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
    }

    .badge-card {
      flex: 1 1 180px;
      border-radius: 12px;
      padding: 10px 12px;
      background: linear-gradient(135deg, #fef3c7, #facc15);
      color: #78350f;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }

    .badge-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .badge-content {
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge-content span.name {
      font-weight: 700;
    }

    .history-title {
      margin-top: 20px;
      margin-bottom: 6px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #111827;
    }

    .history-wrapper {
      overflow-x: auto;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      background: #f9fafb;
      border-radius: 8px;
      overflow: hidden;
    }

    .history-table th,
    .history-table td {
      padding: 6px 8px;
      border: 1px solid #e5e7eb;
      text-align: center;
    }

    .history-table th {
      background: #eff6ff;
      font-weight: 600;
    }

    .history-table td.winner-cell {
      font-weight: 600;
      color: #92400e;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Desafio da 츼gua 游눦</h1>
    <div class="subtitle">Quem bebe mais 치gua hoje?</div>

    <div class="top-row">
      <div class="goal-group">
        Meta di치ria:
        <input type="number" id="goalInput" value="2000" min="250" step="250" />
        <span>ml</span>
      </div>
      <button class="reset-btn" id="resetDay">Zerar dia</button>
    </div>

    <div class="players">
      <!-- Jogador 1: Gabriela -->
      <div class="card" data-player="1">
        <div class="card-header">
          <input class="name-input" id="name1" value="Gabriela" />
          <div class="total">
            <div>Total</div>
            <strong><span id="total1">0</span> ml</strong>
          </div>
        </div>

        <div class="progress-bar-wrapper">
          <div class="progress-bar" id="bar1"></div>
        </div>
        <div class="progress-text" id="progressText1">0% da meta</div>

        <div class="buttons">
          <button class="btn" data-inc="100">+100 ml</button>
          <button class="btn" data-inc="150">+150 ml</button>
          <button class="btn" data-inc="200">+200 ml</button>
          <button class="btn" data-inc="250">+250 ml</button>
          <button class="btn" data-inc="500">+500 ml</button>
        </div>
      </div>

      <!-- Jogador 2: Rafael -->
      <div class="card" data-player="2">
        <div class="card-header">
          <input class="name-input" id="name2" value="Rafael" />
          <div class="total">
            <div>Total</div>
            <strong><span id="total2">0</span> ml</strong>
          </div>
        </div>

        <div class="progress-bar-wrapper">
          <div class="progress-bar" id="bar2"></div>
        </div>
        <div class="progress-text" id="progressText2">0% da meta</div>

        <div class="buttons">
          <button class="btn" data-inc="100">+100 ml</button>
          <button class="btn" data-inc="150">+150 ml</button>
          <button class="btn" data-inc="200">+200 ml</button>
          <button class="btn" data-inc="250">+250 ml</button>
          <button class="btn" data-inc="500">+500 ml</button>
        </div>
      </div>
    </div>

    <!-- Placas douradas de vencedor -->
    <div class="badges">
      <div class="badge-card">
        <div class="badge-title">Vencedor do dia</div>
        <div class="badge-content" id="dailyBadge">
          Ainda sem dados hoje.
        </div>
      </div>
      <div class="badge-card">
        <div class="badge-title">Vencedor da semana (칰ltimos 7 dias)</div>
        <div class="badge-content" id="weeklyBadge">
          Sem dados suficientes ainda.
        </div>
      </div>
    </div>

    <!-- Hist칩rico (칰ltimas 4 semanas) -->
    <h2 class="history-title">Hist칩rico (칰ltimas 4 semanas)</h2>
    <div class="history-wrapper">
      <table class="history-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Gabriela (ml)</th>
            <th>Rafael (ml)</th>
            <th>Vencedor do dia</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr>
            <td colspan="4">Sem dados ainda.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      updateDoc,
      onSnapshot,
      serverTimestamp,
      increment
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // 游댮 SUBSTITUA ESTE BLOCO PELO firebaseConfig QUE O FIREBASE TE DEU
    const firebaseConfig = {
      apiKey: "AIzaSyBW2CUtP_2KzG4jhutTyRFhhC28WSJ158c",
      authDomain: "agua-606e1.firebaseapp.com",
      projectId: "agua-606e1",
      storageBucket: "agua-606e1.firebasestorage.app",
      messagingSenderId: "142132177022",
      appId: "1:142132177022:web:2b4031a24ba9383202102f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dailyTotalsCol = collection(db, "dailyTotals");

    // ---- L칍GICA DO APP ----
    function getTodayKey() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDateBr(key) {
      const [y, m, d] = key.split("-");
      return `${d}/${m}/${y}`;
    }

    function parseKeyToDate(key) {
      const [y, m, d] = key.split("-");
      return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
    }

    let history = {};

    window.addEventListener("load", () => {
      const goalInput = document.getElementById("goalInput");
      const resetDayBtn = document.getElementById("resetDay");
      const dailyBadge = document.getElementById("dailyBadge");
      const weeklyBadge = document.getElementById("weeklyBadge");

      const state = {
        goal: parseInt(goalInput.value, 10) || 2000,
        players: {
          1: { total: 0 },
          2: { total: 0 }
        }
      };

      function updateDailyBadge() {
        const t1 = state.players[1].total;
        const t2 = state.players[2].total;
        const name1 = document.getElementById("name1").value || "Gabriela";
        const name2 = document.getElementById("name2").value || "Rafael";

        if (t1 === 0 && t2 === 0) {
          dailyBadge.textContent = "Ainda sem dados hoje.";
        } else if (t1 === t2) {
          dailyBadge.textContent = "Empate hoje! Continuem bebendo 치gua 游땏";
        } else if (t1 > t2) {
          dailyBadge.innerHTML = `游끥 <span class="name">${name1}</span> est치 na frente hoje (${t1} ml vs ${t2} ml)`;
        } else {
          dailyBadge.innerHTML = `游끥 <span class="name">${name2}</span> est치 na frente hoje (${t2} ml vs ${t1} ml)`;
        }
      }

      function updateUI() {
        const goal = state.goal;

        [1, 2].forEach((id) => {
          const total = state.players[id].total;
          const totalSpan = document.getElementById("total" + id);
          const bar = document.getElementById("bar" + id);
          const progressText = document.getElementById("progressText" + id);

          totalSpan.textContent = total;

          const pct = goal > 0 ? Math.min(100, Math.round((total / goal) * 100)) : 0;
          bar.style.width = pct + "%";
          progressText.textContent = pct + "% da meta";
        });

        updateDailyBadge();
      }

      function updateHistoryUI() {
        const tbody = document.getElementById("historyBody");
        const dates = Object.keys(history);

        if (!dates.length) {
          tbody.innerHTML = '<tr><td colspan="4">Sem dados ainda.</td></tr>';
          return;
        }

        dates.sort((a, b) => b.localeCompare(a)); // mais recente primeiro

        const now = new Date();
        const cutoff = new Date();
        cutoff.setDate(now.getDate() - 27); // 칰ltimos 28 dias

        const rows = [];

        dates.forEach((dateKey) => {
          const d = parseKeyToDate(dateKey);
          if (d < cutoff) return;

          const data = history[dateKey] || {};
          const g = data[1] || 0;
          const r = data[2] || 0;

          let winnerLabel = "-";
          let winnerIcon = "";
          if (g === 0 && r === 0) {
            winnerLabel = "Sem registro";
          } else if (g === r) {
            winnerLabel = "Empate";
          } else if (g > r) {
            winnerLabel = "Gabriela";
            winnerIcon = "游끥";
          } else {
            winnerLabel = "Rafael";
            winnerIcon = "游끥";
          }

          rows.push(
            `<tr>
              <td>${formatDateBr(dateKey)}</td>
              <td>${g}</td>
              <td>${r}</td>
              <td class="winner-cell">${winnerIcon} ${winnerLabel}</td>
            </tr>`
          );
        });

        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="4">Sem dados recentes.</td></tr>';
        } else {
          tbody.innerHTML = rows.join("");
        }
      }

      function updateWeeklyWinner() {
        const now = new Date();
        const cutoff = new Date();
        cutoff.setDate(now.getDate() - 6); // 칰ltimos 7 dias

        let total1 = 0;
        let total2 = 0;

        Object.entries(history).forEach(([key, data]) => {
          const d = parseKeyToDate(key);
          if (d < cutoff || d > now) return;
          total1 += data[1] || 0;
          total2 += data[2] || 0;
        });

        const name1 = document.getElementById("name1").value || "Gabriela";
        const name2 = document.getElementById("name2").value || "Rafael";

        if (total1 === 0 && total2 === 0) {
          weeklyBadge.textContent = "Sem dados suficientes ainda.";
        } else if (total1 === total2) {
          weeklyBadge.textContent = "Empate na semana! 游땏";
        } else if (total1 > total2) {
          weeklyBadge.innerHTML = `游끥 <span class="name">${name1}</span> est치 vencendo na semana (${total1} ml vs ${total2} ml)`;
        } else {
          weeklyBadge.innerHTML = `游끥 <span class="name">${name2}</span> est치 vencendo na semana (${total2} ml vs ${total1} ml)`;
        }
      }

      async function addWaterFirestore(playerId, inc) {
        const todayKey = getTodayKey();
        const docRef = doc(dailyTotalsCol, todayKey);
        const field = playerId === 1 ? "total1" : "total2";

        // Atualiza localmente para sensa칞칚o imediata
        state.players[playerId].total = Math.max(0, state.players[playerId].total + inc);
        updateUI();

        try {
          await setDoc(
            docRef,
            {
              dateKey: todayKey,
              createdAt: serverTimestamp()
            },
            { merge: true }
          );

          await updateDoc(docRef, {
            [field]: increment(inc),
            updatedAt: serverTimestamp()
          });
        } catch (e) {
          console.error("Erro ao atualizar Firestore:", e);
        }
      }

      async function resetToday() {
        const todayKey = getTodayKey();
        const docRef = doc(dailyTotalsCol, todayKey);

        state.players[1].total = 0;
        state.players[2].total = 0;
        updateUI();

        try {
          await setDoc(
            docRef,
            {
              dateKey: todayKey,
              total1: 0,
              total2: 0,
              updatedAt: serverTimestamp()
            },
            { merge: true }
          );
        } catch (e) {
          console.error("Erro ao resetar Firestore:", e);
        }
      }

      function subscribeHistory() {
        onSnapshot(dailyTotalsCol, (snapshot) => {
          const newHistory = {};
          snapshot.forEach((docSnap) => {
            const key = docSnap.id;
            const data = docSnap.data();
            newHistory[key] = {
              1: data.total1 || 0,
              2: data.total2 || 0
            };
          });
          history = newHistory;

          const todayKey = getTodayKey();
          if (history[todayKey]) {
            state.players[1].total = history[todayKey][1] || 0;
            state.players[2].total = history[todayKey][2] || 0;
          } else {
            state.players[1].total = 0;
            state.players[2].total = 0;
          }

          updateUI();
          updateHistoryUI();
          updateWeeklyWinner();
        });
      }

      // Meta di치ria
      goalInput.addEventListener("input", () => {
        const value = parseInt(goalInput.value, 10);
        if (!isNaN(value) && value > 0) {
          state.goal = value;
          updateUI();
        }
      });

      // Bot칫es de cada jogador
      document.querySelectorAll(".card").forEach((card) => {
        const playerId = parseInt(card.getAttribute("data-player"), 10);
        card.querySelectorAll(".btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const inc = parseInt(btn.getAttribute("data-inc"), 10);
            addWaterFirestore(playerId, inc);
          });
        });
      });

      // Reset do dia
      resetDayBtn.addEventListener("click", () => {
        resetToday();
      });

      // Inicia
      updateUI();
      subscribeHistory();

      // Service worker (PWA)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js")
          .catch((err) => console.log("Falha ao registrar service worker:", err));
      }
    });
  </script>
</body>
</html>


